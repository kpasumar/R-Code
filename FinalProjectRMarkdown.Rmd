---
title: "STAT 331 Final Project"
author: "Krishna Prem Pasumarthy & Islam Amin"
date: "`r format(Sys.Date(), format = '%B %d, %Y')`"
output:
  pdf_document:
    number_sections: yes
  html_document:
    df_print: paged
---

\section{Summary}




\section{Descriptive Statistics}

First, take a look at summary statistics of the \texttt{fhsd} dataset.

```{r echo=FALSE}
library(knitr)
suppressWarnings(library(kableExtra))
# Hide NA values from summary statistics which appear for categorical variates
options(knitr.kable.NA = '') 
fhsd <- read.csv('fhs.csv')
# summary statistics on explanatory variables broken into two small tables
kable(summary(fhsd[,1:9]), "latex", caption = "Summary Statistics", booktabs = T) %>%
kable_styling(latex_options = c("striped", "hold_position", "scale_down"))
kable(summary(fhsd[,10:18]), "latex", booktabs = T) %>%
kable_styling(latex_options = c("striped", "hold_position", "scale_down"))
```

First observation we make from the summary is that the median and average ages are around 60, which means the survey seems to have been done on a relatively old group of people. We also have a significantly higher number of females in the study, almost 30% more than the number of males. This might affect the nature of the data to be skewed towards behaviours and physical attributes associated with females.

Then take a look at \texttt{chdrisk} grouped by \texttt{sex} as well as \texttt{chdrisk} grouped by \texttt{cursmoke}.

```{r,echo=FALSE}
by(fhsd$chdrisk, fhsd$sex, summary)
by(fhsd$chdrisk, fhsd$cursmoke, summary)
```


[ADD SOME COMMENTS HERE REGARDING SUMMARY]

\newpage

Now take a look at pair plots of all numeric explanatory variates i.e. variates excluding response variate \texttt{chdrisk} and logical variates such as \texttt{cursmoke}. 


```{r echo=FALSE,fig.width= 8,fig.height=8.5}
# pair plots for continuous variates
pairs(~ totchol + age + sysbp + diabp + cigpday + bmi + 
        heartrte + glucose + hdlc + ldlc, 
      col = "blue",                                         # Change color
      pch = 18,                                            # Change shape of points
      cex = 0.4,
      gap = 1,
      main = "Pair Plots of Continuous Variates",
      data = fhsd)
```

From the pair plots, we can observe a strong correlation between low density lipoprotein cholesterol and serum total cholestrol. This correlation could be explained by the fact that there could be a relationship between
the amount [TO BE CONTINUED]

Now take a look at the VIFs of these variates.


```{r echo=FALSE}
# design matrix excluding intercept
X <- model.matrix(lm(chdrisk ~ . -  1, data = fhsd))
# remove linearly dependent column (sexMale = 1 - sexFemale)
X <- X[,-1]
# calculate vif
vif <- diag(solve(cor(X)))
vif
```


[ADD COMMENTS]

\newpage

\section{Candidate Models}

\subsection{Automated Model Selection}

```{r}
library(gtools)
load_calcs = TRUE
# model with only intercept
M0 <- lm(I(logit(chdrisk)) ~ 1, data = fhsd)
Mmax <- lm(I(logit(chdrisk)) ~ (.)^2, data = fhsd)
# starting model for stepwise selection
Mstart <- lm(I(logit(chdrisk)) ~ ., data = fhsd) 
# find model coefficients which are NA
beta.max <- coef(Mmax)
names(beta.max)[is.na(beta.max)]
# find the problem with the NA coeffs
kable(table(fhsd[c("cursmoke", "cigpday")]), "latex")
kable(table(fhsd[c("bpmeds", "prevhyp")]), "latex")
# remove the coeffs with the problem and add quadratic terms for the continuous variables
Mmax <- lm(I(logit(chdrisk)) ~ (.)^2 - cursmoke:cigpday - bpmeds:prevhyp + 
             I(totchol ^ 2) + I(sysbp ^ 2) + I(diabp ^ 2) 
           + I(bmi ^ 2) + I(glucose ^ 2)
           + I(hdlc ^ 2) + I(ldlc ^ 2), data = fhsd)
anyNA(coef(Mmax)) # check if there are any remaining NAs
if(!load_calcs){
  #forward model selection
  system.time({
    Mfwd <- step(object = M0,
                  scope = list(lower = M0, upper = Mmax),
                  direction = "forward", trace = FALSE)
  })
  
  #backward model selection
  system.time({
    Mback <- step(object = Mmax,
                  scope = list(lower = M0, upper = Mmax),
                  direction = "backward", trace = FALSE)
  })
  
  #stepwise model selection
  system.time({
    Mstep <- step(object = Mstart,
                  scope = list(lower = M0, upper = Mmax),
                  direction = "both", trace = FALSE)
  })
}
# the caching/loading block
if(!load_calcs) {
  saveRDS(list(Mfwd = Mfwd, Mback = Mback, Mstep = Mstep), file = "models_automated.rds") 
} else {
  # just load the calculations
  tmp <- readRDS("models_automated.rds")
  Mfwd <- tmp$Mfwd
  Mback <- tmp$Mback
  Mstep <- tmp$Mstep
  rm(tmp) # optionally remove tmp from workspace
}
# Stepwise model selection
Mstep$call
# Forward model selection
Mfwd$call
# Backward model selection
Mback$call
beta.fwd = coef(Mfwd)
beta.back = coef(Mback)
beta.step = coef(Mstep)
identical(names(beta.fwd)[names(beta.fwd) %in% names(beta.back)], names(beta.fwd))
identical(names(beta.fwd)[names(beta.fwd) %in% names(beta.step)], names(beta.fwd))
identical(names(beta.back)[names(beta.back) %in% names(beta.step)], names(beta.back))
```


\subsection{Manual Model Selection}

```{r}
library(stringr) # For string operations
 table <- c() # Initialize empty vector
 names.table <- names(beta.step)                  # Obtain variate names in stepwise model 
 names.table <- str_remove_all(names.table,"Yes") # Remove "Yes" from interactions
 names.table <- str_remove_all(names.table,"Male") # Remove "Male"
 # Perform F-tests with Mstep by removing one variate at a time 
  for(i in names.table){
    # Obtain model without variate i
    mdl <- lm(as.formula(paste0("update(Mstep, . ~ . -", i,")")),data = fhsd)
   test <- anova(Mstep,mdl)               # F-Test between Stepwise and reduced model
   table <- cbind(table,test$`Pr(>F)`[2]) # Add corresponding p-value to the table
  }
 table <- as.data.frame(table)
 colnames(table) <- names.table            # Add appropriate column names to the table
sort(table,decreasing = TRUE)              # Arrange variates by decreasing significance
# Remove as many insignificant continuous variate interactions as possible
anova(Mstep, update(Mstep,. ~ . - cigpday:heartrte - diabp:cigpday))
#anova(Mstep, update(Mstep,. ~ . - cigpday:heartrte - diabp:cigpday -age:heartrte))
# Now remove less insignificant interactions
anova(Mstep, update(Mstep,. ~ . - cigpday:heartrte - diabp:cigpday - cigpday:heartrte 
                    - bpmeds:prevstrk))
Mdl_manual <- update(Mstep,. ~ . - cigpday:heartrte - diabp:cigpday - cigpday:heartrte 
                    - bpmeds:prevstrk)     # Denotes manually constructed model
```

\section{Model Diagnostics}

\subsection{Leverage and Influence Measures}

```{r}
# hatvalues(Mstep) # Leverages of stepwise model
# 
# cooks.distance(Mstep)
```

\section{Model Selection}


\section{Discussion}
